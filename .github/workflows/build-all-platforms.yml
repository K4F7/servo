name: Build Servo All Platforms

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
          - production
      run_tests:
        description: 'Run unit tests'
        required: false
        default: false
        type: boolean

env:
  RUST_BACKTRACE: 1
  SHELL: /bin/bash
  CARGO_INCREMENTAL: 0

jobs:
  # ==================== Linux Build ====================
  linux:
    name: Linux Build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          large-packages: false
          swap-storage: false

      - name: Set LIBCLANG_PATH
        run: echo "LIBCLANG_PATH=/usr/lib/llvm-14/lib" >> $GITHUB_ENV

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Bootstrap dependencies
        timeout-minutes: 15
        run: |
          sudo apt update
          ./mach bootstrap --skip-lints

      - name: Install crown
        run: cargo install --path support/crown

      - name: Build (${{ inputs.profile || 'release' }})
        run: |
          ./mach build --use-crown --locked --profile ${{ inputs.profile || 'release' }}

      - name: Smoketest
        run: xvfb-run ./mach smoketest --profile ${{ inputs.profile || 'release' }}

      - name: Unit tests
        if: ${{ inputs.run_tests }}
        run: ./mach test-unit --profile ${{ inputs.profile || 'release' }}

      - name: Build package
        run: ./mach package --profile ${{ inputs.profile || 'release' }}

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: servo-linux-${{ inputs.profile || 'release' }}
          path: target/${{ inputs.profile || 'release' }}/servo-tech-demo.tar.gz

  # ==================== Windows Build ====================
  windows:
    name: Windows Build
    runs-on: windows-2022
    env:
      CARGO_TARGET_DIR: C:\a\servo\servo\target
      LIBCLANG_PATH: C:\Program Files\LLVM\bin
      RUSTUP_WINDOWS_PATH_ADD_BIN: 1
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Bootstrap
        run: |
          .\mach fetch
          .\mach bootstrap-gstreamer

      - name: Install crown
        run: cargo install --path support/crown --force

      - name: Build (${{ inputs.profile || 'release' }})
        run: |
          .\mach build --use-crown --locked --profile ${{ inputs.profile || 'release' }}

      - name: Smoketest
        run: .\mach smoketest --profile ${{ inputs.profile || 'release' }}

      - name: Install cargo nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Unit tests
        if: ${{ inputs.run_tests }}
        run: ./mach test-unit --profile ${{ inputs.profile || 'release' }}

      - name: Build package
        run: .\mach package --profile ${{ inputs.profile || 'release' }}

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: servo-windows-${{ inputs.profile || 'release' }}
          path: C:\a\servo\servo\target\${{ inputs.profile || 'release' }}\msi\Servo.exe

  # ==================== macOS Intel Build ====================
  macos-intel:
    name: macOS Intel Build
    runs-on: macos-13
    steps:
      - name: Kill XProtect
        run: |
          echo "Killing XProtect..."; sudo pkill -9 XProtect >/dev/null || true;

      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Bootstrap
        run: |
          ./mach bootstrap --skip-lints
          brew install gnu-tar

      - name: Install crown
        run: cargo install --path support/crown

      - name: Build (${{ inputs.profile || 'release' }})
        run: |
          ./mach build --use-crown --locked --profile ${{ inputs.profile || 'release' }}

      - name: Smoketest
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          command: ./mach smoketest --profile ${{ inputs.profile || 'release' }}

      - name: Unit tests
        if: ${{ inputs.run_tests }}
        run: ./mach test-unit --profile ${{ inputs.profile || 'release' }}

      - name: Build package
        run: ./mach package --profile ${{ inputs.profile || 'release' }}

      - name: Upload macOS Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: servo-macos-intel-${{ inputs.profile || 'release' }}
          path: target/${{ inputs.profile || 'release' }}/servo-tech-demo.dmg

  # ==================== macOS ARM64 Build ====================
  macos-arm64:
    name: macOS ARM64 Build
    runs-on: macos-15
    steps:
      - name: Kill XProtect
        run: |
          echo "Killing XProtect..."; sudo pkill -9 XProtect >/dev/null || true;

      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Bootstrap
        run: |
          ./mach bootstrap --skip-lints
          brew install gnu-tar

      - name: Install crown
        run: cargo install --path support/crown

      - name: Build (${{ inputs.profile || 'release' }})
        run: |
          ./mach build --use-crown --locked --profile ${{ inputs.profile || 'release' }}

      - name: Smoketest
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          command: ./mach smoketest --profile ${{ inputs.profile || 'release' }}

      - name: Unit tests
        if: ${{ inputs.run_tests }}
        run: ./mach test-unit --profile ${{ inputs.profile || 'release' }}

      - name: Build package
        run: ./mach package --profile ${{ inputs.profile || 'release' }}

      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: servo-macos-arm64-${{ inputs.profile || 'release' }}
          path: target/${{ inputs.profile || 'release' }}/servo-tech-demo.dmg

  # ==================== Android Build ====================
  android:
    name: Android Build (${{ matrix.target }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        target:
          - aarch64-linux-android
          - armv7-linux-androideabi
          - x86_64-linux-android
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          large-packages: false
          swap-storage: false

      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Bootstrap dependencies
        run: sudo apt update && ./mach bootstrap --skip-lints --skip-nextest

      - name: Install crown
        run: cargo install --path support/crown

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'tools platform-tools platforms;android-33'

      - name: Install Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28b

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download Gradle
        run: |
          for i in {1..4}; do
            ./gradlew --version && break || { echo "Downloading Gradle failed (attempt $i)." && sleep $((3 ** $i)); };
          done
        working-directory: ./support/android/apk/

      - name: Build (${{ matrix.target }} - ${{ inputs.profile || 'release' }})
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          ./mach build --use-crown --locked --target ${{ matrix.target }} --profile ${{ inputs.profile || 'release' }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: servo-android-${{ matrix.target }}-${{ inputs.profile || 'release' }}
          path: target/android/${{ matrix.target }}/${{ inputs.profile || 'release' }}/servoapp.apk

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: servo-android-aar-${{ matrix.target }}-${{ inputs.profile || 'release' }}
          path: target/android/${{ matrix.target }}/${{ inputs.profile || 'release' }}/servoview.aar

  # ==================== Build Summary ====================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - linux
      - windows
      - macos-intel
      - macos-arm64
      - android
    steps:
      - name: Check build results
        run: |
          echo "=== Build Results ==="
          echo "Linux: ${{ needs.linux.result }}"
          echo "Windows: ${{ needs.windows.result }}"
          echo "macOS Intel: ${{ needs.macos-intel.result }}"
          echo "macOS ARM64: ${{ needs.macos-arm64.result }}"
          echo "Android: ${{ needs.android.result }}"

      - name: Success
        if: ${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}
        run: |
          echo "All builds completed successfully!"
          exit 0

      - name: Failure
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: |
          echo "Some builds failed or were cancelled"
          exit 1
